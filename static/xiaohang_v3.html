<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èˆªè¾…å¯¼æ¨¡å— - å¢å¼ºç‰ˆ v3</title>
    
    <!-- å¼•å…¥ä¾èµ– -->
    <script src="/static/js/marked.min.js"></script>
    <link rel="stylesheet" href="/static/css/github.min.css">
    <script src="/static/js/highlight.min.js"></script>
    <link rel="stylesheet" href="/static/css/katex.min.css">
    <script defer src="/static/js/katex.min.js"></script>
    <script defer src="/static/js/auto-render.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
    
    <!-- Mermaid.js ç”¨äºç»˜åˆ¶æµç¨‹å›¾å’ŒISPOå›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <!-- Monaco Editor ä»£ç ç¼–è¾‘å™¨ -->
    <script src="/static/js/monaco-editor-init.js"></script>
    <link rel="stylesheet" href="/static/css/monaco-editor.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .header .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .content {
            padding: 40px;
        }
        
        /* é˜¶æ®µå®¹å™¨ */
        .stage {
            display: none;
        }
        
        .stage.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* çŸ¥è¯†ç‚¹é€‰æ‹© */
        .selection-title {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .selection-title h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .selection-title .hint {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .knowledge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .knowledge-btn {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s;
            text-align: center;
        }
        
        .knowledge-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .knowledge-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .knowledge-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .selection-footer {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .selection-info {
            font-size: 18px;
            margin-bottom: 20px;
            color: #34495e;
        }
        
        .selected-count {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .confirm-btn {
            padding: 15px 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }
        
        .confirm-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* ç»ƒä¹ é˜¶æ®µ */
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .practice-header h2 {
            font-size: 24px;
        }
        
        .badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .badge.ç®€å• {
            background: #2ecc71;
            color: white;
        }
        
        .badge.ä¸­ç­‰ {
            background: #f39c12;
            color: white;
        }
        
        .badge.å›°éš¾ {
            background: #e74c3c;
            color: white;
        }
        
        /* éš¾åº¦é€‰æ‹©å™¨æ ·å¼ */
        .difficulty-selector {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            border: none;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding-right: 35px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }
        
        .difficulty-selector:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.5);
        }
        
        .difficulty-selector option {
            background: #2c3e50;
            color: white;
            padding: 10px;
        }
        
        .difficulty-selector.ç®€å• {
            background-color: #2ecc71;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E"), linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            background-repeat: no-repeat, no-repeat;
            background-position: right 12px center, 0 0;
            background-size: auto, 100% 100%;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }
        
        .difficulty-selector.ä¸­ç­‰ {
            background-color: #f39c12;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E"), linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            background-repeat: no-repeat, no-repeat;
            background-position: right 12px center, 0 0;
            background-size: auto, 100% 100%;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.4);
        }
        
        .difficulty-selector.å›°éš¾ {
            background-color: #e74c3c;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E"), linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            background-repeat: no-repeat, no-repeat;
            background-position: right 12px center, 0 0;
            background-size: auto, 100% 100%;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
        }
        
        .problem-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h3 {
            font-size: 20px;
            color: #2c3e50;
        }
        
        .refresh-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .problem-display {
            background: white;
            padding: 25px;
            border-radius: 10px;
            min-height: 200px;
            line-height: 1.8;
        }
        
        .practice-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        
        @media (max-width: 1200px) {
            .practice-content {
                grid-template-columns: 1fr;
            }
        }
        
        .code-section, .guidance-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            min-height: 500px;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .code-editor {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            resize: vertical;
            background: #ffffff;
        }
        
        /* Monaco Editor å®¹å™¨æ ·å¼ */
        #monaco-editor-container {
            width: 100%;
            height: 400px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            border-bottom: 1px solid #404040;
        }
        
        .editor-toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .editor-toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .editor-lang-badge {
            background: #0078d4;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .editor-lang-select {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 28px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s;
        }
        
        .editor-lang-select:hover {
            background-color: #106ebe;
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.4);
        }
        
        .editor-lang-select option {
            background: #2d2d2d;
            color: white;
            padding: 8px;
        }
        
        .editor-status {
            color: #888;
            font-size: 12px;
        }
        
        .editor-btn {
            padding: 6px 12px;
            background: #404040;
            color: #ccc;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .editor-btn:hover {
            background: #505050;
            color: white;
        }
        
        .editor-btn.primary {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
        }
        
        .editor-btn.primary:hover {
            background: #106ebe;
        }
        
        .editor-shortcuts {
            color: #666;
            font-size: 11px;
            margin-top: 8px;
        }
        
        .editor-shortcuts kbd {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 11px;
        }
        
        .submit-btn {
            margin-top: 15px;
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .guidance-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .guidance-btn {
            padding: 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .guidance-btn:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateX(5px);
        }
        
        .guidance-btn .btn-icon {
            font-size: 28px;
            display: block;
            margin-bottom: 8px;
        }
        
        .guidance-btn .btn-text {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        
        .guidance-btn .btn-desc {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        /* ä»£ç æ¡†æ¶æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .guidance-btn.framework-btn {
            background: linear-gradient(135deg, #f0f3ff 0%, #e8ecff 100%);
            border-color: #667eea;
        }
        
        .guidance-btn.framework-btn:hover {
            background: linear-gradient(135deg, #e8ecff 0%, #d4daff 100%);
        }
        
        .judgment-result, .guidance-display {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
        }
        
        /* æ¡†æ¶å±•ç¤ºåŒºåŸŸ */
        .framework-display {
            margin-top: 20px;
            padding: 25px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 15px;
        }
        
        .framework-display .mermaid {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .restart-section {
            text-align: center;
            margin-top: 40px;
        }
        
        .restart-btn {
            padding: 15px 40px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .restart-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 3px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* é—®å·é—®é¢˜é«˜äº®æ ·å¼ */
        .question-highlight {
            color: #e67e22 !important;
            font-weight: 600;
            background: linear-gradient(120deg, #f39c12 0%, #e67e22 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }
        
        /* æ§åˆ¶ç»“æ„å›¾ä¾‹ */
        .control-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }
        
        .legend-color.sequence { background: #3498db; }
        .legend-color.selection { background: #e74c3c; }
        .legend-color.loop { background: #27ae60; }
        
        /* ISPOå¡ç‰‡æ ·å¼ï¼ˆInput â†’ Storage â†’ Process â†’ Outputï¼‰ */
        .ipo-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .ipo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .ipo-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
            gap: 10px;
            align-items: stretch;
        }
        
        .ipo-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .ipo-box.input { background: linear-gradient(135deg, #e8f4fd 0%, #d4e9f7 100%); }
        .ipo-box.storage { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); }
        .ipo-box.process { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
        .ipo-box.output { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
        
        .ipo-arrow {
            display: flex;
            align-items: center;
            font-size: 24px;
            color: #bdc3c7;
        }
        
        /* åˆ†è§£æç¤ºæ¡† */
        .decomposition-prompt {
            background: linear-gradient(135deg, #f0f3ff 0%, #e8ecff 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #667eea;
        }
        
        .decomposition-prompt h4 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .user-choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .choice-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .choice-btn.can-write {
            background: #27ae60;
            color: white;
        }
        
        .choice-btn.need-decompose {
            background: #e74c3c;
            color: white;
        }
        
        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* æ­å–œæ¶ˆæ¯åŠ¨ç”» */
        @keyframes celebrationPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 30px rgba(79, 172, 254, 0.6);
            }
        }
        
        /* éš¾åº¦åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .difficulty-buttons-container {
            margin: 20px 0 !important;
            padding: 0 !important;
        }
        
        .difficulty-switch-btn {
            display: block !important;
            width: 100% !important;
            padding: 15px 25px !important;
            margin: 0 0 12px 0 !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: bold !important;
            font-size: 15px !important;
            text-align: left !important;
            transition: all 0.3s !important;
            color: white !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
        }
        
        .difficulty-switch-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5) !important;
        }
        
        /* æ¡†æ¶å¯è§†åŒ–å¢å¼ºæ ·å¼ */
        .framework-visualization {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ipo-card {
            animation: cardSlideIn 0.4s ease-out;
        }
        
        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .user-prompt-card {
            animation: promptFadeIn 0.5s ease-out;
        }
        
        @keyframes promptFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Mermaidå›¾è¡¨å®¹å™¨æ ·å¼ */
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        
        /* åˆ†è§£æ ‘æ ·å¼ */
        .decomposition-tree .tree-level {
            position: relative;
        }
        
        .decomposition-tree .tree-level::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 0;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
        }
        
        /* æ§åˆ¶ç»“æ„å¾½ç« åŠ¨ç”» */
        .control-badge {
            transition: all 0.3s ease;
        }
        
        .control-badge:hover {
            transform: scale(1.1);
        }
        
        /* ä»£ç æ¡†æ¶å¼¹çª—æ ·å¼ */
        .framework-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: modalFadeIn 0.3s ease;
        }
        
        /* è„šæ‰‹æ¶å·¥å…·æŒ‰é’®æ ·å¼ */
        .scaffold-tool-btn {
            padding: 10px 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .scaffold-tool-btn:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .scaffold-tool-btn span {
            font-size: 16px;
        }
        
        /* è„šæ‰‹æ¶å·¥å…·ç®±åŠ¨ç”» */
        .scaffolding-toolbox {
            animation: toolboxFadeIn 0.5s ease-out;
        }
        
        @keyframes toolboxFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* è¯Šæ–­ç»“æœæ ·å¼å¢å¼º */
        .diagnosis-result {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .diagnosis-result h4 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        /* æç¤ºçº§åˆ«æ ‡ç­¾æ ·å¼ */
        .hint-level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .hint-level-badge.level-1 {
            background: #3498db;
            color: white;
        }
        
        .hint-level-badge.level-2 {
            background: #f39c12;
            color: white;
        }
        
        .hint-level-badge.level-3 {
            background: #e74c3c;
            color: white;
        }
        
        /* æ€è€ƒé—®é¢˜é«˜äº® */
        .thinking-question {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #f39c12;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
        }
        
        .thinking-question::before {
            content: 'ğŸ¤” ';
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .framework-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .framework-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            flex-shrink: 0;
        }
        
        .framework-modal-header h3 {
            margin: 0;
            font-size: 22px;
        }
        
        .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close-btn:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }
        
        .framework-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        /* å¼¹çª—å†…çš„Mermaidå›¾è¡¨æ›´å¤§ */
        .framework-modal-body .mermaid svg {
            min-height: 250px;
        }
        
        /* å¼¹çª—å†…çš„ISPOå¡ç‰‡æ›´å®½æ• */
        .framework-modal-body .ipo-card {
            margin: 20px 0;
        }
        
        .framework-modal-body .ipo-flow {
            gap: 20px;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='/'">â† è¿”å›ä¸»é¡µ</button>
    
    <div class="main-container">
        <div class="header">
            <span class="version-badge">v3.0 - ISPOå¯è§†åŒ–ç‰ˆ</span>
            <h1>ğŸš€ å°èˆªæ™ºèƒ½è¾…å¯¼ç³»ç»Ÿ</h1>
            <p>ä¸ªæ€§åŒ–å­¦ä¹  Â· å±‚æ¬¡åŒ–åˆ†è§£ Â· ISPOå¯è§†åŒ– Â· æ§åˆ¶ç»“æ„æ ‡æ³¨</p>
        </div>
        
        <div class="content">
            <!-- é˜¶æ®µ1: çŸ¥è¯†ç‚¹é€‰æ‹© -->
            <div id="stage-selection" class="stage active">
                <div class="selection-title">
                    <h2>ğŸ“š è¯·é€‰æ‹©ä½ æƒ³æé«˜çš„çŸ¥è¯†ç‚¹</h2>
                    <p class="hint">æœ€å¤šé€‰æ‹©3ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…</p>
                </div>
                
                <div class="knowledge-grid" id="knowledge-grid">
                    <!-- JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="selection-footer">
                    <div class="selection-info">
                        å·²é€‰æ‹©: <span class="selected-count" id="selected-count">0</span> / 3
                    </div>
                    <button id="confirm-btn" class="confirm-btn" onclick="confirmSelection()" disabled>
                        å¼€å§‹å­¦ä¹  â†’
                    </button>
                </div>
            </div>
            
            <!-- é˜¶æ®µ2: ç¼–ç¨‹ç»ƒä¹  -->
            <div id="stage-practice" class="stage">
                <div class="practice-header">
                    <h2>ğŸ’¡ ç¼–ç¨‹ç»ƒä¹ </h2>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div>
                            <span>éš¾åº¦: </span>
                            <select id="difficulty-selector" class="difficulty-selector" onchange="onDifficultySelect(this.value)">
                                <option value="ç®€å•" selected>ç®€å•</option>
                                <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                                <option value="å›°éš¾">å›°éš¾</option>
                            </select>
                            <span style="margin-left: 20px;">è¿›åº¦: <span id="completed-count">0</span>/3</span>
                        </div>
                        <button onclick="showKnowledgeSeeking()" style="padding: 10px 20px; background: rgba(255,255,255,0.3); color: white; border: 2px solid white; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='white'; this.style.color='#667eea';" onmouseout="this.style.background='rgba(255,255,255,0.3)'; this.style.color='white';">
                            ğŸ“– çŸ¥è¯†ç‚¹æ€»ç»“
                        </button>
                    </div>
                </div>
                
                <!-- æ§åˆ¶ç»“æ„å›¾ä¾‹ -->
                <div class="control-legend">
                    <div class="legend-item">
                        <div class="legend-color sequence"></div>
                        <span>ğŸ“‹ é¡ºåºç»“æ„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color selection"></div>
                        <span>ğŸ”€ é€‰æ‹©ç»“æ„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color loop"></div>
                        <span>ğŸ”„ å¾ªç¯ç»“æ„</span>
                    </div>
                </div>
                
                <!-- é¢˜ç›®åŒºåŸŸ -->
                <div class="problem-section">
                    <div class="section-header">
                        <h3>ğŸ“ é¢˜ç›®</h3>
                        <button onclick="generateNewProblem()" class="refresh-btn">ğŸ”„ æ¢ä¸€é¢˜</button>
                    </div>
                    <div id="problem-display" class="problem-display markdown-body">
                        <p class="loading"></p>
                    </div>
                </div>
                
                <!-- ä¸»è¦å†…å®¹ -->
                <div class="practice-content">
                    <!-- å·¦ä¾§: ä»£ç ç¼–è¾‘ -->
                    <div class="code-section">
                        <h3>ğŸ’» ä»£ç ç¼–è¾‘å™¨</h3>
                        
                        <!-- Monaco Editor å®¹å™¨ -->
                        <div id="monaco-editor-wrapper">
                            <div class="editor-toolbar">
                                <div class="editor-toolbar-left">
                                    <select id="language-selector" class="editor-lang-select" onchange="handleLanguageChange(this.value)">
                                        <option value="c">C è¯­è¨€</option>
                                        <option value="python">Python</option>
                                    </select>
                                    <span class="editor-status" id="editor-status">å°±ç»ª</span>
                                </div>
                                <div class="editor-toolbar-right">
                                    <button class="editor-btn" onclick="MonacoEditorManager.toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                                        ğŸŒ“ ä¸»é¢˜
                                    </button>
                                    <button class="editor-btn" onclick="MonacoEditorManager.clear()" title="æ¸…ç©ºä»£ç ">
                                        ğŸ—‘ï¸ æ¸…ç©º
                                    </button>
                                    <button class="editor-btn" onclick="formatCode()" title="æ ¼å¼åŒ–ä»£ç  (Ctrl+Shift+F)">
                                        ğŸ“ æ ¼å¼åŒ–
                                    </button>
                                </div>
                            </div>
                            <div id="monaco-editor-container"></div>
                        </div>
                        
                        <div class="editor-shortcuts">
                            å¿«æ·é”®: <kbd>Ctrl</kbd>+<kbd>Enter</kbd> æäº¤ | 
                            <kbd>Ctrl</kbd>+<kbd>Space</kbd> è‡ªåŠ¨è¡¥å…¨ | 
                            <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>F</kbd> æ ¼å¼åŒ–
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="submitCode()" class="submit-btn" style="flex: 1;">
                                æäº¤ä»£ç  âœ“
                            </button>
                            <button onclick="showThoughtInput()" class="submit-btn" style="background: #9b59b6; flex: 0 0 auto; padding: 12px 20px;" title="æè¿°ä½ çš„æ€è·¯ï¼Œè·å¾—æ›´ç²¾å‡†çš„åé¦ˆ">
                                ğŸ’­ å¸¦æ€è·¯æäº¤
                            </button>
                        </div>
                        
                        <div id="judgment-result" class="judgment-result" style="display: none;">
                            <h4>ğŸ“Š è¯„åˆ¤ç»“æœ</h4>
                            <div id="judgment-content" class="markdown-body"></div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§: æ™ºèƒ½è¾…å¯¼ -->
                    <div class="guidance-section">
                        <h3>ğŸ¯ æ™ºèƒ½è¾…å¯¼</h3>
                        <div class="guidance-buttons">
                            <button class="guidance-btn" onclick="getGuidance('æ€è·¯')">
                                <span class="btn-icon">ğŸ’­</span>
                                <span class="btn-text">æ™ºèƒ½å®¡é¢˜</span>
                                <span class="btn-desc">ç®€æ´æ€è·¯å¼•å¯¼</span>
                            </button>
                            
                            <button class="guidance-btn framework-btn" onclick="getFrameworkGuidance()">
                                <span class="btn-icon">ğŸ—ï¸</span>
                                <span class="btn-text">ä»£ç æ¡†æ¶ (IPOå¯è§†åŒ–)</span>
                                <span class="btn-desc">å±‚æ¬¡åŒ–åˆ†è§£ Â· IPOå›¾ Â· æ§åˆ¶ç»“æ„æ ‡æ³¨</span>
                            </button>
                            
                            <button class="guidance-btn" onclick="getGuidance('ä¼ªä»£ç ')">
                                <span class="btn-icon">ğŸ“‹</span>
                                <span class="btn-text">ä»£ç åˆ†æ</span>
                                <span class="btn-desc">ä¼ªä»£ç è¡¥å……</span>
                            </button>
                            
                            <button class="guidance-btn" onclick="getGuidance('æ ¸å¿ƒè¯­å¥')">
                                <span class="btn-icon">ğŸ”‘</span>
                                <span class="btn-text">å…³é”®ç‚¹æ‹¨</span>
                                <span class="btn-desc">æ ¸å¿ƒä»£ç æ¡†æ¶</span>
                            </button>
                            
                            <button class="guidance-btn" onclick="getCorrectAnswer()" style="background: linear-gradient(135deg, #a8e6cf 0%, #7ed6a8 100%); color: #2c3e50; border-color: #7ed6a8;">
                                <span class="btn-icon">âœ…</span>
                                <span class="btn-text">æ­£ç¡®ç­”æ¡ˆ</span>
                                <span class="btn-desc">æŸ¥çœ‹å®Œæ•´ä»£ç </span>
                            </button>
                        </div>
                        
                        <!-- è„šæ‰‹æ¶å·¥å…·ç®± -->
                        <div class="scaffolding-toolbox" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 15px; border: 2px dashed #667eea;">
                            <h4 style="color: #667eea; margin-bottom: 15px; font-size: 15px;">ğŸ› ï¸ è„šæ‰‹æ¶å·¥å…·ç®± <span style="font-size: 12px; font-weight: normal; color: #888;">ï¼ˆæäº¤ä»£ç åå¯ç”¨ï¼‰</span></h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="getHint(1)" class="scaffold-tool-btn" title="è½»å¾®ç‚¹æ‹¨ï¼Œä¸ç›´æ¥ç»™ç­”æ¡ˆ">
                                    <span>ğŸ’¡</span> Level 1
                                </button>
                                <button onclick="getHint(2)" class="scaffold-tool-btn" title="ç”¨åä¾‹å¼•å¯¼æ€è€ƒ">
                                    <span>ğŸ¯</span> Level 2
                                </button>
                                <button onclick="getHint(3)" class="scaffold-tool-btn" title="å›é¡¾ç›¸å…³ç®—æ³•æ¦‚å¿µ">
                                    <span>ğŸ“š</span> Level 3
                                </button>
                                <button onclick="generateCounterexample()" class="scaffold-tool-btn" title="æ„é€ æœ€å°åä¾‹">
                                    <span>ğŸ”¬</span> åä¾‹
                                </button>
                                <button onclick="analyzeComplexity()" class="scaffold-tool-btn" style="grid-column: span 2;" title="åˆ†ææ—¶é—´å’Œç©ºé—´å¤æ‚åº¦">
                                    <span>â±ï¸</span> å¤æ‚åº¦åˆ†æ
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ¡†æ¶å±•ç¤ºåŒºåŸŸï¼ˆå°æç¤ºï¼‰ -->
                        <div id="framework-hint" class="framework-display" style="display: none;">
                            <div style="text-align: center; padding: 20px;">
                                <p style="color: #667eea;">ğŸ“Š ä»£ç æ¡†æ¶å·²åœ¨å¼¹çª—ä¸­å±•ç¤º</p>
                                <button onclick="openFrameworkModal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">é‡æ–°æ‰“å¼€</button>
                            </div>
                        </div>
                        
                        <div id="guidance-display" class="guidance-display" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 id="guidance-title">è¾…å¯¼å†…å®¹</h4>
                                <button onclick="closeGuidance()" class="close-btn">âœ•</button>
                            </div>
                            <div id="guidance-content" class="markdown-body"></div>
                        </div>
                    </div>
                </div>
                
                <div class="restart-section">
                    <button onclick="restartSession()" class="restart-btn">ğŸ”„ é‡æ–°é€‰æ‹©çŸ¥è¯†ç‚¹</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/xiaohang_enhanced.js"></script>
    <script src="/static/xiaohang_framework.js"></script>
    
    <!-- ä»£ç æ¡†æ¶å¼¹çª— -->
    <div id="framework-modal" class="framework-modal" style="display: none;">
        <div class="framework-modal-content">
            <div class="framework-modal-header">
                <h3>ğŸ—ï¸ ä»£ç æ¡†æ¶ - å±‚æ¬¡åŒ–åˆ†è§£</h3>
                <button onclick="closeFrameworkModal()" class="modal-close-btn">âœ•</button>
            </div>
            <div id="framework-content" class="framework-modal-body"></div>
        </div>
    </div>
    
    <script>
        // å½“å‰åˆ†è§£å±‚çº§ï¼ˆç”±xiaohang_framework.jsç®¡ç†ï¼‰
        // let currentDecompositionLevel = 1;
        // let decompositionHistory = [];
        
        // è·å–ä»£ç æ¡†æ¶è¾…å¯¼ï¼ˆå¸¦IPOå¯è§†åŒ–ï¼‰- ä½¿ç”¨å¼¹çª—å±•ç¤º
        async function getFrameworkGuidance() {
            currentGuidanceType = 'æ¡†æ¶';
            
            // æ˜¾ç¤ºå¼¹çª—
            const modal = document.getElementById('framework-modal');
            const frameworkContent = document.getElementById('framework-content');
            const guidanceDisplay = document.getElementById('guidance-display');
            const frameworkHint = document.getElementById('framework-hint');
            
            // éšè—æ™®é€šè¾…å¯¼æ˜¾ç¤º
            guidanceDisplay.style.display = 'none';
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            frameworkContent.innerHTML = '<p class="loading" style="text-align: center; padding: 60px;">æ­£åœ¨è¿›è¡Œå±‚æ¬¡åŒ–åˆ†è§£...</p>';
            
            // æ˜¾ç¤ºå°æç¤º
            if (frameworkHint) {
                frameworkHint.style.display = 'block';
            }
            
            try {
                const response = await fetch('/api/xiaohang/get_guidance', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'æ¡†æ¶' })
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æ¡†æ¶å¤±è´¥');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                
                // æµå¼æ¥æ”¶æ—¶åªæ˜¾ç¤ºåŠ è½½æç¤ºï¼Œä¸æ˜¾ç¤ºåŸå§‹JSON
                frameworkContent.innerHTML = '<p class="loading" style="text-align: center; padding: 60px;">æ­£åœ¨ç”Ÿæˆä»£ç æ¡†æ¶å¯è§†åŒ–...</p>';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    fullText += chunk;
                }
                
                // æ¥æ”¶å®Œæˆåï¼Œæ¸…ç©ºå®¹å™¨å¹¶æ¸²æŸ“å¯è§†åŒ–
                frameworkContent.innerHTML = '';
                
                // å°è¯•è§£æJSONå¹¶ç”Ÿæˆå¯è§†åŒ–
                await parseAndVisualizeFramework(fullText, frameworkContent);
                
            } catch (error) {
                console.error('Error:', error);
                frameworkContent.innerHTML = '<p style="color: red; text-align: center; padding: 40px;">è·å–æ¡†æ¶å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }
        
        // æ‰“å¼€æ¡†æ¶å¼¹çª—
        function openFrameworkModal() {
            const modal = document.getElementById('framework-modal');
            modal.style.display = 'flex';
        }
        
        // å…³é—­æ¡†æ¶å¼¹çª—
        function closeFrameworkModal() {
            const modal = document.getElementById('framework-modal');
            modal.style.display = 'none';
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('framework-modal');
            if (e.target === modal) {
                closeFrameworkModal();
            }
        });
        
        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFrameworkModal();
            }
        });
        
        // è§£æå¹¶å¯è§†åŒ–æ¡†æ¶
        async function parseAndVisualizeFramework(text, container) {
            console.log('parseAndVisualizeFramework è¢«è°ƒç”¨ï¼Œæ–‡æœ¬é•¿åº¦:', text.length);
            
            try {
                let jsonStr = null;
                
                // æ–¹æ³•1: å°è¯•æå– ```json ``` åŒ…è£¹çš„å†…å®¹
                const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                    console.log('æ–¹æ³•1æˆåŠŸï¼šä»```json```ä¸­æå–');
                }
                
                // æ–¹æ³•2: å¦‚æœæ²¡æœ‰ä»£ç å—åŒ…è£¹ï¼Œå°è¯•ä»ç¬¬ä¸€ä¸ª{åˆ°æœ€åä¸€ä¸ª}
                if (!jsonStr) {
                    const firstBrace = text.indexOf('{');
                    const lastBrace = text.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                        jsonStr = text.substring(firstBrace, lastBrace + 1);
                        console.log('æ–¹æ³•2æˆåŠŸï¼šä»ç¬¬ä¸€ä¸ª{åˆ°æœ€åä¸€ä¸ª}æå–');
                    }
                }
                
                // æ–¹æ³•3: å°è¯•ç›´æ¥æŸ¥æ‰¾JSONå¯¹è±¡
                if (!jsonStr) {
                    const jsonObjectMatch = text.match(/\{[\s\S]*"parentProblem"[\s\S]*"subProblems"[\s\S]*\}/);
                    if (jsonObjectMatch) {
                        jsonStr = jsonObjectMatch[0];
                        console.log('æ–¹æ³•3æˆåŠŸï¼šæ­£åˆ™åŒ¹é…');
                    }
                }
                
                if (jsonStr) {
                    // å°è¯•ä¿®å¤ä¸å®Œæ•´çš„JSON
                    jsonStr = tryFixIncompleteJson(jsonStr);
                    
                    try {
                        const decompositionData = JSON.parse(jsonStr);
                        console.log('JSONè§£ææˆåŠŸï¼ŒparentProblem:', decompositionData.parentProblem);
                        
                        // æ¸…ç©ºå®¹å™¨ï¼Œç„¶åæ¸²æŸ“å¯è§†åŒ–ï¼ˆæ›¿æ¢è€Œä¸æ˜¯è¿½åŠ ï¼‰
                        container.innerHTML = '';
                        
                        // ä½¿ç”¨æ–°çš„å¯è§†åŒ–æ¸²æŸ“å™¨
                        await FrameworkVisualizer.renderFullVisualization(decompositionData, container);
                        console.log('å¯è§†åŒ–æ¸²æŸ“å®Œæˆ');
                        return; // æˆåŠŸï¼Œç›´æ¥è¿”å›
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                    }
                }
                
                // è§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹å’Œé”™è¯¯æç¤º
                console.log('JSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹');
                container.innerHTML = `
                    <div class="raw-response" style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h5 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">ğŸ“ AIåˆ†è§£ç»“æœ</h5>
                        <div class="markdown-body">${marked.parse(text)}</div>
                    </div>
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <p style="color: #856404; margin: 0;">
                            <strong>âš ï¸ æç¤ºï¼š</strong>AIè¿”å›çš„ç»“æ„åŒ–æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ–‡æœ¬å†…å®¹ã€‚
                            <br><small>æ‚¨å¯ä»¥ç‚¹å‡»"ä»£ç æ¡†æ¶"æŒ‰é’®é‡æ–°ç”Ÿæˆã€‚</small>
                        </p>
                    </div>
                `;
                
                // è¯­æ³•é«˜äº®
                if (typeof hljs !== 'undefined') {
                    container.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
            } catch (e) {
                console.error('Parse error:', e);
                container.innerHTML = '<p style="color: red; text-align: center; padding: 40px;">è§£ææ¡†æ¶æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }
        
        // å°è¯•ä¿®å¤ä¸å®Œæ•´çš„JSON
        function tryFixIncompleteJson(jsonStr) {
            // ç§»é™¤æœ«å°¾çš„ä¸å®Œæ•´å†…å®¹
            jsonStr = jsonStr.trim();
            
            // è®¡ç®—æ‹¬å·å¹³è¡¡
            let braceCount = 0;
            let bracketCount = 0;
            let lastValidIndex = 0;
            let inString = false;
            let escapeNext = false;
            
            for (let i = 0; i < jsonStr.length; i++) {
                const char = jsonStr[i];
                
                if (escapeNext) {
                    escapeNext = false;
                    continue;
                }
                
                if (char === '\\') {
                    escapeNext = true;
                    continue;
                }
                
                if (char === '"') {
                    inString = !inString;
                    continue;
                }
                
                if (!inString) {
                    if (char === '{') braceCount++;
                    else if (char === '}') {
                        braceCount--;
                        if (braceCount === 0) lastValidIndex = i;
                    }
                    else if (char === '[') bracketCount++;
                    else if (char === ']') bracketCount--;
                }
            }
            
            // å¦‚æœæ‹¬å·ä¸å¹³è¡¡ï¼Œå°è¯•æˆªæ–­åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆä½ç½®
            if (braceCount !== 0 || bracketCount !== 0) {
                if (lastValidIndex > 0) {
                    jsonStr = jsonStr.substring(0, lastValidIndex + 1);
                } else {
                    // å°è¯•æ·»åŠ ç¼ºå¤±çš„æ‹¬å·
                    while (bracketCount > 0) {
                        jsonStr += ']';
                        bracketCount--;
                    }
                    while (braceCount > 0) {
                        jsonStr += '}';
                        braceCount--;
                    }
                }
            }
            
            return jsonStr;
        }
        
        // å…³é—­æ¡†æ¶æ˜¾ç¤º
        function closeFramework() {
            closeFrameworkModal();
            const frameworkHint = document.getElementById('framework-hint');
            if (frameworkHint) {
                frameworkHint.style.display = 'none';
            }
            decompositionNavigator.reset();
        }
        
        // åˆå§‹åŒ–Mermaid
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis',
                        padding: 20
                    },
                    themeVariables: {
                        primaryColor: '#667eea',
                        primaryTextColor: '#fff',
                        primaryBorderColor: '#764ba2',
                        lineColor: '#667eea',
                        secondaryColor: '#f8f9fa',
                        tertiaryColor: '#e9ecef'
                    }
                });
                console.log('Mermaid initialized successfully');
            } else {
                console.error('Mermaid library not loaded');
            }
        });
        
        // Monaco Editor åˆå§‹åŒ–
        let monacoEditorReady = false;
        let monacoInitializing = false;
        
        async function initializeMonacoEditor() {
            if (monacoEditorReady || monacoInitializing) return;
            monacoInitializing = true;
            
            try {
                const statusEl = document.getElementById('editor-status');
                if (statusEl) statusEl.textContent = 'åŠ è½½ä¸­...';
                
                await MonacoEditorManager.init('monaco-editor-container', {
                    language: 'c',
                    theme: 'vs-dark',
                    fontSize: 14,
                    minimap: false,
                    initialCode: `#include <stdio.h>

int main() {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„Cè¯­è¨€ä»£ç 
    
    return 0;
}
`
                });
                
                monacoEditorReady = true;
                if (statusEl) statusEl.textContent = 'å°±ç»ª';
                
                // ç›‘å¬æäº¤å¿«æ·é”®
                document.addEventListener('editor-submit', function(e) {
                    submitCode();
                });
                
                console.log('Monaco Editor åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('Monaco Editor åˆå§‹åŒ–å¤±è´¥:', error);
                const statusEl = document.getElementById('editor-status');
                if (statusEl) statusEl.textContent = 'ä½¿ç”¨åŸºç¡€ç¼–è¾‘å™¨';
                
                // é™çº§åˆ°æ™®é€š textarea
                fallbackToTextarea();
                return false;
            } finally {
                monacoInitializing = false;
            }
        }
        
        // é™çº§åˆ°æ™®é€š textarea
        function fallbackToTextarea() {
            const wrapper = document.getElementById('monaco-editor-wrapper');
            if (wrapper) {
                wrapper.innerHTML = `
                    <textarea id="code-editor-fallback" class="code-editor" style="width:100%;min-height:400px;font-family:Consolas,monospace;font-size:14px;padding:15px;border:2px solid #dee2e6;border-radius:10px;">#include <stdio.h>

int main() {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„Cè¯­è¨€ä»£ç 
    
    return 0;
}
</textarea>
                `;
            }
            monacoEditorReady = false; // æ ‡è®°ä¸ºæœªä½¿ç”¨ Monaco
        }
        
        // è·å–ç¼–è¾‘å™¨ä»£ç ï¼ˆå…¼å®¹ Monaco å’Œ textareaï¼‰
        function getEditorCode() {
            if (monacoEditorReady && typeof MonacoEditorManager !== 'undefined' && MonacoEditorManager.getCode) {
                return MonacoEditorManager.getCode();
            }
            const fallback = document.getElementById('code-editor-fallback');
            if (fallback) {
                return fallback.value;
            }
            return '';
        }
        
        // è®¾ç½®ç¼–è¾‘å™¨ä»£ç 
        function setEditorCode(code) {
            if (monacoEditorReady && typeof MonacoEditorManager !== 'undefined' && MonacoEditorManager.setCode) {
                MonacoEditorManager.setCode(code);
            } else {
                const fallback = document.getElementById('code-editor-fallback');
                if (fallback) {
                    fallback.value = code;
                }
            }
        }
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditorCode(skipConfirm = false) {
            if (monacoEditorReady && typeof MonacoEditorManager !== 'undefined' && MonacoEditorManager.clear) {
                MonacoEditorManager.clear(skipConfirm);
            } else {
                const fallback = document.getElementById('code-editor-fallback');
                if (fallback) {
                    const currentCode = fallback.value.trim();
                    if (currentCode === '' || skipConfirm || confirm('ç¡®å®šè¦æ¸…ç©ºä»£ç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                        const lang = document.getElementById('language-selector')?.value || 'c';
                        const templates = {
                            c: `#include <stdio.h>

int main() {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„Cè¯­è¨€ä»£ç 
    
    return 0;
}
`,
                            python: `# åœ¨è¿™é‡Œç¼–å†™ä½ çš„Pythonä»£ç 

def main():
    pass

if __name__ == "__main__":
    main()
`
                        };
                        fallback.value = templates[lang];
                    }
                }
            }
        }
        
        // æ ¼å¼åŒ–ä»£ç 
        function formatCode() {
            if (monacoEditorReady && typeof MonacoEditorManager !== 'undefined') {
                const editor = MonacoEditorManager.getEditor();
                if (editor) {
                    editor.getAction('editor.action.formatDocument').run();
                }
            }
        }
        
        // å¤„ç†è¯­è¨€åˆ‡æ¢
        function handleLanguageChange(language) {
            if (monacoEditorReady && typeof MonacoEditorManager !== 'undefined') {
                MonacoEditorManager.switchLanguage(language);
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const statusEl = document.getElementById('editor-status');
                if (statusEl) {
                    statusEl.textContent = language === 'c' ? 'C è¯­è¨€' : 'Python';
                    setTimeout(() => { statusEl.textContent = 'å°±ç»ª'; }, 1000);
                }
            } else {
                // é™çº§æ¨¡å¼ä¸‹çš„å¤„ç†
                const fallback = document.getElementById('code-editor-fallback');
                if (fallback) {
                    const templates = {
                        c: `#include <stdio.h>

int main() {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„Cè¯­è¨€ä»£ç 
    
    return 0;
}
`,
                        python: `# åœ¨è¿™é‡Œç¼–å†™ä½ çš„Pythonä»£ç 

def main():
    pass

if __name__ == "__main__":
    main()
`
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é»˜è®¤æ¨¡æ¿
                    const currentCode = fallback.value.trim();
                    const cDefault = templates.c.trim();
                    const pyDefault = templates.python.trim();
                    
                    if (currentCode === cDefault || currentCode === pyDefault || currentCode === '') {
                        fallback.value = templates[language];
                    }
                }
            }
        }
        
        // é‡å†™ confirmSelection å‡½æ•°ï¼Œåœ¨è¿›å…¥ç»ƒä¹ é˜¶æ®µæ—¶åˆå§‹åŒ– Monaco Editor
        (function() {
            // ç­‰å¾… xiaohang_enhanced.js åŠ è½½å®Œæˆ
            const checkAndOverride = setInterval(function() {
                if (typeof confirmSelection === 'function' && !confirmSelection._wrapped) {
                    const originalConfirmSelection = confirmSelection;
                    
                    window.confirmSelection = async function() {
                        // å…ˆåˆå§‹åŒ– Monaco Editor
                        await initializeMonacoEditor();
                        
                        // è°ƒç”¨åŸå§‹çš„ç¡®è®¤é€‰æ‹©å‡½æ•°
                        return originalConfirmSelection.apply(this, arguments);
                    };
                    
                    window.confirmSelection._wrapped = true;
                    clearInterval(checkAndOverride);
                    console.log('confirmSelection å·²åŒ…è£…ï¼ŒMonaco Editor å°†åœ¨å¼€å§‹å­¦ä¹ æ—¶åŠ è½½');
                }
            }, 100);
            
            // 5ç§’ååœæ­¢æ£€æŸ¥
            setTimeout(function() {
                clearInterval(checkAndOverride);
            }, 5000);
        })();
    </script>
</body>
</html>
