# 脚手架理论智能辅导系统设计文档

## 1. 设计理念：脚手架理论 (Scaffolding)

### 核心理念
不是"纠错"，而是**"思维对齐"**。

- **不仅看代码，更看意图**：分析代码背后的算法逻辑，而非仅仅检查语法
- **拒绝直接喂饭**：严禁直接给出Correct Solution，而是分层级给出线索
- **注重边界与复杂度**：针对DSA课程特性，重点检查时间复杂度、空间复杂度和边界条件

## 2. 系统核心流程 (Core Workflow)

整个流程分为四个阶段：

### 2.1 提交与预判 (Submission & Pre-check)
- 学生提交代码 + (可选) 简单的思路描述
- 系统接收代码和思路，准备进行智能诊断

### 2.2 沙箱执行 (Execution)
- 系统先运行测试用例
- 如果编译错误：直接反馈编译器报错
- 如果逻辑错误/超时：捕获失败的测试用例（Input/Output）和错误类型

### 2.3 大模型诊断 (AI Diagnosis)
- 将题目、学生代码、失败用例、标准解法（对学生不可见）打包发送给LLM
- LLM执行代码理解、差距分析、生成提示

### 2.4 交互式反馈 (Interactive Feedback)
- LLM生成"点拨式"建议，展示给学生
- 学生可以选择不同级别的提示继续深入

## 3. 详细功能模块设计

### 模块一：智能诊断引擎 (The Brain)

#### 输入数据 (Prompt Context)
- **题目描述**：完整的题目文本
- **知识点标签**：如二叉树遍历、动态规划、双指针
- **学生代码**：原始代码
- **执行结果**：在输入为 [1, 2] 时，预期输出 3，实际输出 2
- **标准思路**：题目的标准解题逻辑摘要（对学生不可见）

#### AI 处理逻辑 (Prompt Strategy)
1. **代码理解**：解释学生代码试图做什么
2. **差距分析**：找出学生逻辑与正确逻辑的偏差
3. **生成提示**：根据错误严重程度，选择提示等级

#### 提示等级设计 (Hint Hierarchy)
| 级别 | 名称 | 示例 |
|------|------|------|
| Level 1 | 轻微提示 | "注意一下循环结束的条件，是不是少处理了一个元素？" |
| Level 2 | 反例提示 | "如果输入是空数组 []，你的代码会发生什么？" |
| Level 3 | 概念回溯 | "你的算法时间复杂度是 O(n²)，但这道题的数据规模要求 O(n log n)，试着回忆一下归并排序的思路。" |

### 模块二：反例生成器 (Counter-example Generator)

对于算法题，最好的老师往往是一个**"让代码崩溃的输入"**。

#### 功能
- 如果测试用例太长难以阅读，LLM可以尝试构造一个**最小反例 (Minimal Counter-example)**

#### 示例
- **场景**：学生写了一个判断回文串的代码，漏了大小写转换
- **助手**："你的逻辑大体正确，但试着输入 'A man, a plan'，看看你的程序输出了什么？这符合预期吗？"

### 模块三：复杂度分析卫士 (Complexity Guardian)

DSA课程非常看重复杂度。

#### 功能
- **静态分析**：LLM分析代码的循环嵌套层级和递归深度
- **反馈**：如果学生写了暴力解法，助手应提示优化方向

#### 示例
"你的解法在逻辑上是通的，但是面对 10⁵ 的数据量会超时。你能想到利用'哈希表'来优化查找速度吗？"

## 4. 关键Prompt设计

### System Prompt
```
**Role:** 你是数据结构与算法课程的资深助教。你的目标是帮助学生自己发现代码中的逻辑错误，而不是直接告诉他们答案。

**Rules:**
1. **禁止直接写代码:** 绝对不要直接重写正确的代码给学生
2. **先肯定，后指正:** 先指出学生思路中正确的部分，再指出问题
3. **使用苏格拉底式提问:** 用问题引导思考
4. **聚焦关键点:** 每次只纠正一个最核心的逻辑错误
5. **术语准确:** 使用标准的DSA术语

**Task:**
分析用户的代码和报错信息，根据题目要求分析学生为什么错了，提供"关键点拨"帮助学生修正思维模型。
```

## 5. API 接口设计

### 5.1 提交代码 (智能诊断)
```
POST /api/xiaohang/submit_code
Body: { code: string, thought?: string }
Response: 流式返回诊断结果
```

### 5.2 生成反例
```
POST /api/xiaohang/generate_counterexample
Body: { code: string }
Response: 流式返回最小反例
```

### 5.3 复杂度分析
```
POST /api/xiaohang/analyze_complexity
Body: { code: string }
Response: 流式返回复杂度分析报告
```

### 5.4 分层提示
```
POST /api/xiaohang/get_hint
Body: { level: 1|2|3, code: string, question?: string }
Response: 流式返回对应级别的提示
```

### 5.5 代码行级评论
```
POST /api/xiaohang/code_review
Body: { code: string }
Response: 流式返回JSON格式的行级评论
```

## 6. 用户界面设计 (UI/UX)

### 6.1 脚手架工具箱
在智能辅导区域添加"脚手架工具箱"，包含：
- Level 1/2/3 提示按钮
- 反例生成器按钮
- 复杂度分析按钮

### 6.2 带思路提交
- 新增"带思路提交"按钮
- 弹出模态框让学生描述解题思路
- 思路描述帮助AI更精准地理解学生意图

### 6.3 诊断结果展示
- 使用Markdown渲染诊断结果
- 支持KaTeX数学公式（复杂度表达式）
- 高亮引导性问题
- 在结果下方显示脚手架工具按钮

## 7. 技术实现

### 后端 (Python/Flask)
- `app_xiaohang_enhanced.py` 新增API端点
- 使用Redis存储诊断历史和提示历史
- 流式响应支持实时反馈

### 前端 (JavaScript)
- `xiaohang_enhanced.js` 新增脚手架功能函数
- `xiaohang_v3.html` 新增UI组件
- 支持KaTeX数学公式渲染

## 8. 未来扩展

- [ ] 代码行级高亮标记（类似Code Review）
- [ ] 思维导图模式（算法流程可视化）
- [ ] 多轮对话追问
- [ ] 学习进度追踪
- [ ] 个性化提示策略
